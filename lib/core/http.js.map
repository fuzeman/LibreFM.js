{"version":3,"sources":["core/http.js"],"names":["HttpClient","client","baseUrl","_client","_baseUrl","method","options","params","authenticated","sessionKey","getSessionKey","signed","key","Error","_generateSignature","fetch","encode","then","response","json","body","headers","Headers","signature","value","Object","keys","sort","forEach","secret","toString"],"mappings":"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","file":"http.js","sourcesContent":["import Hex from 'crypto-js/enc-hex';\r\nimport Md5 from 'crypto-js/md5';\r\nimport Merge from 'lodash-amd/merge';\r\nimport QueryString from 'querystring';\r\n\r\nimport {isDefined} from './helpers';\r\n\r\n\r\nexport default class HttpClient {\r\n    constructor(client, baseUrl) {\r\n        this._client = client;\r\n        this._baseUrl = baseUrl || 'https://libre.fm/2.0/';\r\n    }\r\n\r\n    get(method, options) {\r\n        options = Merge({\r\n            params: {},\r\n\r\n            authenticated: false,\r\n            sessionKey: this._client.getSessionKey()\r\n        }, options || {});\r\n\r\n        options.signed = isDefined(options.signed) ?\r\n            options.signed :\r\n            options.authenticated;\r\n\r\n        // Set request parameters\r\n        options.params['api_key'] = this._client.key;\r\n        options.params['format'] = 'json';\r\n        options.params['method'] = method;\r\n\r\n        if(options.authenticated) {\r\n            // Add session key\r\n            if(!isDefined(options.sessionKey)) {\r\n                throw new Error('Missing required \"sessionKey\" parameter');\r\n            }\r\n\r\n            options.params['sk'] = options.sessionKey;\r\n        }\r\n\r\n        if(options.signed) {\r\n            // Generate signature\r\n            options.params['api_sig'] = this._generateSignature(options.params);\r\n        }\r\n\r\n        // Send request\r\n        return fetch(\r\n            this._baseUrl + '?' + QueryString.encode(options.params)\r\n        ).then(function(response) {\r\n            // TODO check status code\r\n            return response.json();\r\n        });\r\n    }\r\n\r\n    post(method, options) {\r\n        options = Merge({\r\n            params: {},\r\n\r\n            authenticated: false,\r\n            sessionKey: this._client.getSessionKey()\r\n        }, options || {});\r\n\r\n        options.signed = isDefined(options.signed) ?\r\n            options.signed :\r\n            options.authenticated;\r\n\r\n        // Set request parameters\r\n        options.params['api_key'] = this._client.key;\r\n        options.params['format'] = 'json';\r\n        options.params['method'] = method;\r\n\r\n        if(options.authenticated) {\r\n            // Add session key\r\n            if(!isDefined(options.sessionKey)) {\r\n                throw new Error('Missing required \"sessionKey\" parameter');\r\n            }\r\n\r\n            options.params['sk'] = options.sessionKey;\r\n        }\r\n\r\n        if(options.signed) {\r\n            // Generate signature\r\n            options.params['api_sig'] = this._generateSignature(options.params);\r\n        }\r\n\r\n        // Send request\r\n        return fetch(this._baseUrl, {\r\n            method: 'POST',\r\n            body: QueryString.encode(options.params),\r\n\r\n            headers: new Headers({\r\n                'Content-Type': 'application/x-www-form-urlencoded'\r\n            })\r\n        }).then(function(response) {\r\n            // TODO check status code\r\n            return response.json();\r\n        });\r\n    }\r\n\r\n    _generateSignature(params) {\r\n        var signature = '';\r\n\r\n        // Append parameters\r\n        var value;\r\n\r\n        Object.keys(params).sort().forEach((key) => {\r\n            if(key === 'format') {\r\n                return;\r\n            }\r\n\r\n            // Retrieve value\r\n            value = params[key];\r\n\r\n            if(typeof value === 'undefined' || value === null) {\r\n                value = '';\r\n            }\r\n\r\n            // Append parameter\r\n            signature += key + value;\r\n        });\r\n\r\n        // Append client secret\r\n        signature += this._client.secret;\r\n\r\n        // Generate hash\r\n        return Md5(signature).toString(Hex);\r\n    }\r\n}\r\n"]}